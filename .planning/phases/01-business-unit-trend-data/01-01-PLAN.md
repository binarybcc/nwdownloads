---
phase: 01-business-unit-trend-data
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/api/legacy.php
  - web/assets/js/core/app.js
autonomous: true

must_haves:
  truths:
    - 'API overview response includes a `business_unit_trends` key containing trend data for each business unit'
    - "Each business unit's trend data contains exactly 12 entries with sequential W1-W12 labels"
    - 'Each entry includes total_active (int or null) and change (int or null) fields'
    - "W1 change and first non-null entry's change are always null"
    - 'Missing weeks are padded with null total_active and null change (not skipped)'
    - 'Multiple snapshots in the same calendar week use the latest snapshot_date only'
    - 'Frontend stores business_unit_trends alongside existing dashboard data for Phase 2 consumption'
  artifacts:
    - path: 'web/api/legacy.php'
      provides: 'getBusinessUnitTrendData() and getAllBusinessUnitTrends() functions'
      contains: 'function getBusinessUnitTrendData'
    - path: 'web/api/legacy.php'
      provides: 'business_unit_trends key in getOverviewEnhanced return array'
      contains: 'business_unit_trends'
    - path: 'web/assets/js/core/app.js'
      provides: 'Frontend extraction of business_unit_trends from API response'
      contains: 'business_unit_trends'
  key_links:
    - from: 'web/api/legacy.php (getOverviewEnhanced)'
      to: 'web/api/legacy.php (getAllBusinessUnitTrends)'
      via: 'function call inside getOverviewEnhanced, passing $week_num and $year'
      pattern: 'getAllBusinessUnitTrends.*pdo.*week_num.*year'
    - from: 'web/assets/js/core/app.js (renderBusinessUnits)'
      to: 'dashboardData.business_unit_trends'
      via: 'reads trend data from the same dashboardData object populated by loadDashboardData'
      pattern: "dashboardData\\.business_unit_trends"
---

<objective>
Extend the existing overview API to serve per-business-unit 12-week trend data, and wire the frontend to store it alongside existing dashboard data.

Purpose: Provide the data foundation that Phase 2 needs to render trend charts inside each business unit card. Without this data layer, the charts have nothing to display.

Output: The overview API response includes a `business_unit_trends` map (keyed by business unit name) with 12 weekly entries each containing W-labels, Total Active counts, and week-over-week change values. The frontend stores this data for Phase 2 chart rendering.
</objective>

<execution_context>
@/Users/johncorbin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johncorbin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-business-unit-trend-data/01-CONTEXT.md
@.planning/phases/01-business-unit-trend-data/01-RESEARCH.md

Key source files to read before implementing:
@web/api/legacy.php (lines 537-962: getOverviewEnhanced function, especially 773-831 for company-wide trend pattern and 913-962 for return array)
@web/assets/js/core/app.js (lines 60-87 for BUSINESS_UNITS config, 129-165 for loadDashboardData, 747-865 for renderBusinessUnits)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add business unit trend functions and embed in overview response</name>
  <files>web/api/legacy.php</files>
  <action>
Add two new PHP functions to `web/api/legacy.php` and wire them into the overview response.

**Function 1: `getBusinessUnitTrendData(PDO $pdo, string $businessUnit, int $weekNum, int $year): array`**

Place this function BEFORE `getOverviewEnhanced()` (before line 537). Follow the existing company-wide trend pattern from lines 773-831 but with these modifications:

1. Calculate start week: `$startWeekNum = $weekNum - 11`, handle year boundary when `$startWeekNum < 1` (copy exact pattern from lines 778-781).
2. Loop 12 times ($i = 0 to 11). Handle `$currentWeekNum > 52` boundary (copy exact pattern from lines 789-792).
3. For each week, query `daily_snapshots`:
   ```sql
   SELECT SUM(total_active) as total_active
   FROM daily_snapshots
   WHERE business_unit = ?
     AND paper_code != 'FN'
     AND week_num = ?
     AND year = ?
     AND snapshot_date = (
       SELECT MAX(sd.snapshot_date)
       FROM daily_snapshots sd
       WHERE sd.business_unit = ?
         AND sd.paper_code != 'FN'
         AND sd.week_num = ?
         AND sd.year = ?
     )
   ```
   The subquery ensures "latest snapshot date wins" when multiple snapshots exist in the same calendar week (per CONTEXT.md decision). Execute with `[$businessUnit, $currentWeekNum, $currentYear, $businessUnit, $currentWeekNum, $currentYear]`.
4. Build the label: `'W' . ($i + 1)` -- sequential W1 through W12.
5. Track `$lastNonNullValue` (initialized to null before the loop). When `$weekData` exists and `total_active` is not null:
   - Cast to int: `$totalActive = (int)$weekData['total_active']`
   - Calculate change: `$change = ($lastNonNullValue !== null) ? $totalActive - $lastNonNullValue : null`
   - Update: `$lastNonNullValue = $totalActive`
   - Append: `['label' => $label, 'total_active' => $totalActive, 'change' => $change]`
6. When week has no data: Append `['label' => $label, 'total_active' => null, 'change' => null]`.
7. Return the 12-element array.

**Function 2: `getAllBusinessUnitTrends(PDO $pdo, int $weekNum, int $year): array`**

Place this immediately after `getBusinessUnitTrendData()`. This function:

1. Define `$units = ['South Carolina', 'Wyoming', 'Michigan']` (matches existing BUSINESS_UNITS in app.js).
2. Loop through units, calling `getBusinessUnitTrendData()` for each.
3. Return associative array keyed by unit name: `[$unit => getBusinessUnitTrendData($pdo, $unit, $weekNum, $year)]`.

**Wire into overview response:**

Inside `getOverviewEnhanced()`, AFTER the `$by_edition` loop (around line 897, before `$dataRange = getDataRange($pdo)` on line 900):

1. Add: `$business_unit_trends = getAllBusinessUnitTrends($pdo, $week_num, $year);`
2. In the return array (lines 913-962), add a new key AFTER `'by_edition'` (line 950):
   ```php
   'business_unit_trends' => $business_unit_trends,
   ```

**Do NOT:**

- Modify the existing company-wide trend code (lines 773-831).
- Use `getHistoricalTrend()` -- it queries the wrong table (`subscriber_snapshots`).
- Use `DAYOFWEEK()` filtering -- use `week_num`/`year` columns.
- Group by `snapshot_date` without the MAX subquery -- that would produce multiple rows per week.
- Create a new API action/endpoint -- embed in the existing overview response.
  </action>
  <verify>
  Start the development environment with `docker compose up -d` (if not running). Then verify the API response:

```bash
# Curl the overview endpoint and check for business_unit_trends key
curl -s 'http://localhost:8081/api.php?action=overview&compare=previous' | python3 -m json.tool | grep -A 5 'business_unit_trends'
```

Expected: The JSON output includes a `business_unit_trends` key with nested objects for `South Carolina`, `Wyoming`, and `Michigan`, each containing a 12-element array with `label`, `total_active`, and `change` fields.

Additional verification:

```bash
# Verify exactly 12 entries per business unit
curl -s 'http://localhost:8081/api.php?action=overview&compare=previous' | python3 -c "
import json, sys
data = json.load(sys.stdin)
trends = data['data']['business_unit_trends']
for unit, entries in trends.items():
    print(f'{unit}: {len(entries)} entries')
    non_null = [e for e in entries if e['total_active'] is not None]
    print(f'  Non-null weeks: {len(non_null)}')
    if non_null:
        print(f'  First non-null change is None: {non_null[0][\"change\"] is None}')
"
```

Expected output: Each unit has exactly 12 entries. First non-null entry's change is None.
</verify>
<done>
The `getOverviewEnhanced()` return value includes `business_unit_trends` with 12-entry arrays for each of the 3 business units. Each entry has `label` (W1-W12), `total_active` (int or null), and `change` (int or null). Missing weeks are null-padded. First non-null change is null. Multiple same-week snapshots use the latest date.
</done>
</task>

<task type="auto">
  <name>Task 2: Wire frontend to store business unit trend data</name>
  <files>web/assets/js/core/app.js</files>
  <action>
Make the frontend aware of the new `business_unit_trends` data from the API response so it is available for Phase 2 chart rendering.

**In `renderBusinessUnits()` function (around line 750):**

After the existing line that reads comparisons data:

```javascript
const comparisons = dashboardData.business_unit_comparisons || {};
```

Add a new line to extract the trend data:

```javascript
const buTrends = dashboardData.business_unit_trends || {};
```

**Inside the business unit loop (around line 771):**

After the existing line:

```javascript
const comparison = comparisons[unitName];
```

Add:

```javascript
const trendData = buTrends[unitName] || [];
```

This makes `trendData` available in the loop body for Phase 2 to use when creating the chart canvas and Chart.js instance.

**Add a data attribute to the card HTML for Phase 2 discovery:**

In the card's opening `<div>` tag (around line 775), add a `data-trend` attribute containing the JSON-encoded trend data:

```javascript
data-bu-trend='${JSON.stringify(trendData)}'
```

Add this attribute to the existing `<div class="paper-card ...">` tag. This allows Phase 2 to read the data directly from the DOM if needed, or it can use the `buTrends` variable from the JavaScript scope.

**Do NOT:**

- Create any chart rendering (that is Phase 2).
- Add any new API fetch calls (data comes embedded in the existing overview response).
- Modify the `loadDashboardData()` function (the data flows through automatically since it reads from `result.data`).
- Remove or modify any existing functionality.
  </action>
  <verify>
  Open http://localhost:8081 in a browser. Open DevTools console and run:

```javascript
// Check that trend data is accessible
console.log(Object.keys(dashboardData.business_unit_trends));
// Expected: ["South Carolina", "Wyoming", "Michigan"]

// Check entry count
Object.entries(dashboardData.business_unit_trends).forEach(([unit, data]) => {
  console.log(`${unit}: ${data.length} entries, labels: ${data.map(d => d.label).join(', ')}`);
});
// Expected: Each unit has 12 entries with labels W1-W12

// Check data attribute on card
document.querySelectorAll('[data-bu-trend]').forEach(el => {
  const trend = JSON.parse(el.getAttribute('data-bu-trend'));
  console.log(`Card trend data: ${trend.length} entries`);
});
// Expected: 3 cards, each with 12 entries
```

All three checks should output the expected values.
</verify>
<done>
The `renderBusinessUnits()` function extracts `business_unit_trends` from the dashboard data and makes it available both as a JavaScript variable (`trendData`) within the card rendering loop and as a `data-bu-trend` attribute on each card DOM element. Phase 2 can access this data to create trend charts.
</done>
</task>

</tasks>

<verification>
After both tasks are complete, verify the full data flow end-to-end:

1. **API returns correct data:**

   ```bash
   curl -s 'http://localhost:8081/api.php?action=overview&compare=previous' | python3 -c "
   import json, sys
   data = json.load(sys.stdin)
   trends = data['data']['business_unit_trends']
   for unit, entries in trends.items():
       print(f'\n{unit}:')
       for e in entries:
           print(f'  {e[\"label\"]}: total_active={e[\"total_active\"]}, change={e[\"change\"]}')
   "
   ```

2. **Frontend receives and stores data:**
   Open http://localhost:8081, wait for dashboard to load, then in DevTools console:

   ```javascript
   JSON.stringify(dashboardData.business_unit_trends, null, 2);
   ```

3. **Cards have data attributes:**

   ```javascript
   document.querySelectorAll('.paper-card[data-bu-trend]').length === 3;
   ```

4. **No regressions:**
   - Dashboard loads without errors
   - All business unit cards display correctly
   - Donut charts render properly
   - Comparison badges show correctly
   - No console errors
     </verification>

<success_criteria>

- The overview API response includes `business_unit_trends` with trend data for all 3 business units
- Each business unit has exactly 12 weekly entries with W1-W12 labels
- Missing weeks are null-padded, change calculations are correct
- Frontend stores the data and attaches it to card DOM elements
- No existing functionality is broken
- Dashboard loads and renders correctly
  </success_criteria>

<output>
After completion, create `.planning/phases/01-business-unit-trend-data/01-01-SUMMARY.md`
</output>
