---
phase: 02-chart-rendering-and-card-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [web/assets/js/core/app.js]
autonomous: true

must_haves:
  truths:
    - 'Each business unit card displays a small line chart with blue area fill between the comparison bar and the donut chart'
    - 'The chart X-axis shows week labels (W1, W2, etc.) along the bottom'
    - 'Hovering over a data point shows a tooltip with the week label, subscriber count, and color-coded week-over-week change'
    - "The chart Y-axis range is scaled to the specific business unit's data, not company totals"
    - 'The chart fills the card width on any screen size'
    - "Business units with no trend data show 'No data available' text instead of an empty chart"
  artifacts:
    - path: 'web/assets/js/core/app.js'
      provides: 'createBUTrendChart helper function, trend chart HTML in BU card template, chart lifecycle management'
      contains: 'createBUTrendChart'
  key_links:
    - from: 'renderBusinessUnits() HTML template'
      to: 'createBUTrendChart()'
      via: 'Canvas element in template, Chart.js instantiation in post-DOM loop'
      pattern: "createBUTrendChart\\("
    - from: 'createBUTrendChart()'
      to: 'trendData from dashboardData.business_unit_trends'
      via: 'trendData variable already extracted in renderBusinessUnits loop'
      pattern: 'trendData'
    - from: 'businessUnitTrendCharts cleanup'
      to: 'renderBusinessUnits() destroy loop'
      via: 'Object.values(businessUnitTrendCharts).forEach(chart => chart.destroy())'
      pattern: 'businessUnitTrendCharts'
---

<objective>
Add a 12-week trend mini-chart to each business unit card on the circulation dashboard.

Purpose: Users see subscriber trends at a glance inside each BU card -- fulfills the core value "each business unit card tells its own trend story at a glance."

Output: Each BU card renders an interactive Chart.js line chart with blue area fill, week labels, hover tooltips with week-over-week change, and auto-scaled Y-axis. Charts are positioned between the comparison bar and the donut chart, responsive to card width.
</objective>

<execution_context>
@/Users/johncorbin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johncorbin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chart-rendering-and-card-integration/02-CONTEXT.md
@.planning/phases/02-chart-rendering-and-card-integration/02-RESEARCH.md
@.planning/phases/01-business-unit-trend-data/01-01-SUMMARY.md
@web/assets/js/core/app.js

**Critical data shape from Phase 1 (01-01-SUMMARY.md):**
The `trendData` array available in the renderBusinessUnits loop has this shape:

```json
[
  {"label": "W1", "total_active": null, "change": null},
  {"label": "W2", "total_active": null, "change": null},
  ...
  {"label": "W8", "total_active": 3112, "change": null},
  {"label": "W9", "total_active": 3106, "change": -6},
  ...up to 12 entries
]
```

- `label`: string like "W1", "W8" (NOT `week_num` integer)
- `total_active`: integer subscriber count or `null` for missing weeks
- `change`: integer week-over-week change or `null`
- Array is always exactly 12 entries (null-padded)
- First non-null entry always has `change: null`

**NOTE:** The RESEARCH.md examples incorrectly reference `week_num` field and integer indexing. Use `label` and `total_active` fields as documented in the Phase 1 summary above.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BU trend chart helper function and lifecycle management</name>
  <files>web/assets/js/core/app.js</files>
  <action>
  Make three changes to app.js:

**1. Declare trend chart storage (near line 64, after `let businessUnitCharts = {};`):**

```javascript
let businessUnitTrendCharts = {}; // Store business unit trend line charts
```

**2. Add destroy loop (near line 776, after the existing `businessUnitCharts` destroy block):**

```javascript
Object.values(businessUnitTrendCharts).forEach(chart => chart.destroy());
businessUnitTrendCharts = {};
```

**3. Create `createBUTrendChart(canvasId, trendData)` helper function.**
Place it BEFORE `renderBusinessUnits()` (similar to how other helper functions are organized).

The function must:

a) **Accept `canvasId` (string) and `trendData` (array from Phase 1).**

b) **Get canvas element.** If not found, return null.

c) **Handle no-data case.** If `!trendData` or `trendData.length === 0` or every entry has `total_active === null`, replace the canvas container content with a centered "No data available" message (text-sm text-gray-400, flex centered, full height) and return null.

d) **Extract labels and data points from the Phase 1 data shape:** - Labels: `trendData.map(d => d.label)` -- gives ["W1", "W2", ..., "W12"] - Data points: `trendData.map(d => d.total_active)` -- gives [null, null, ..., 3112, 3106, ...] - Use `spanGaps: true` in the dataset so the line connects across null gaps (matching company-wide chart behavior) - Do NOT replace nulls with zeros. Use nulls + spanGaps so the line only appears where data exists. This prevents the misleading "dip to zero" effect. CONTEXT.md says "Missing/padded weeks show as zero value" but the Phase 1 implementation chose nulls for a reason -- nulls with spanGaps are visually cleaner.

e) **Calculate auto-scaled Y-axis from real (non-null) values only:** - Filter out null values to get `realValues` - If no real values exist, use min=0, max=100 - Otherwise: min = floor((min_real - 15% padding) / 10) _ 10 (clamped to >= 0), max = ceil((max_real + 15% padding) / 10) _ 10 - This ensures the chart Y-axis fits the specific BU's data range, not company totals (requirement CHART-04)

f) **Create Chart.js instance with this config:** - `type: 'line'` - Dataset: `borderColor: '#3b82f6'`, `backgroundColor: 'rgba(59, 130, 246, 0.1)'`, `tension: 0.4`, `fill: true`, `pointRadius: 3`, `pointHoverRadius: 5`, `pointBackgroundColor: '#3b82f6'`, `pointBorderColor: '#fff'`, `pointBorderWidth: 1`, `spanGaps: true` - These colors/styles match the existing company-wide trend chart (requirement CHART-01) - Options: - `responsive: true`, `maintainAspectRatio: false` (uses container height) - `animation: { duration: 1000, easing: 'easeOutQuart' }` (safe default -- progressive animation may break fill) - `interaction: { intersect: true, mode: 'nearest' }` (highlights individual point only, no crosshair) - `events: ['mousemove', 'mouseout']` (no click events -- prevents card onclick conflict per RESEARCH.md Pitfall 2) - `plugins.legend.display: false` (no legend for mini chart) - `plugins.tooltip.callbacks`: - `title`: return `tooltipItems[0].label` (the week label like "W5") - `label`: Format as "1,234 (+12)" or "1,234 (-6)". Use `formatNumber()` (existing helper in app.js). For the first data point that has data OR when the previous value is null, show count only without change. Use the `change` field from the original `trendData` array (access via closure or store alongside) -- Phase 1 already computed the correct change values including null handling. - `labelTextColor`: Return `#4ade80` (green) for positive change, `#f87171` (red) for negative, `#fff` (white/neutral) for null/zero change or first data point - Scales: - x: `display: true`, `grid.display: false`, `ticks.font.size: 9`, `ticks.maxRotation: 0` - y: `display: false` (hidden per CONTEXT.md), `min: scaleMin`, `max: scaleMax`

g) **Return the Chart instance** (or null if no chart created).

**Important: Store `trendData` in a way that tooltip callbacks can access the original `change` field.** Options:

- Store `trendData` as a closure variable that the callbacks reference
- Or store the change values as a parallel array accessible in the callback

The recommended approach: keep `trendData` in closure scope of the function since tooltip callbacks are defined inline.
</action>
<verify>

1. Grep for `createBUTrendChart` in app.js -- function exists
2. Grep for `businessUnitTrendCharts` -- declared at top and destroyed in renderBusinessUnits
3. Read the function and verify: uses `d.label` and `d.total_active` (NOT `week_num`), uses `spanGaps: true`, Y-axis is `display: false`, events exclude 'click', tooltip callbacks reference `change` field from trendData
   </verify>
   <done>

- `createBUTrendChart(canvasId, trendData)` function exists in app.js
- Function handles: no data (shows message), null-padded data (spanGaps), auto-scaled Y-axis, blue area fill matching company chart
- `businessUnitTrendCharts` object declared and destroyed alongside existing chart cleanup
- Tooltip shows "W5: 1,234 (+12)" format with green/red color-coding
  </done>
  </task>

<task type="auto">
  <name>Task 2: Integrate trend chart into BU card HTML template and rendering loop</name>
  <files>web/assets/js/core/app.js</files>
  <action>
  Make two changes to the `renderBusinessUnits()` function in app.js:

**1. Add trend chart canvas to the BU card HTML template.**

In the template literal that builds card HTML (near line 793), find the comparison bar section which ends with:

```html
</div>
</div>
```

(the progress bar's closing divs, around line 813-814)

And the donut section which starts with:

```html
<div class="mt-4 pt-4 border-t border-gray-100"></div>
```

(around line 815)

INSERT between them (after comparison bar, before donut section):

```javascript
const trendChartId = `trend-${unitName.replace(/\s+/g, '-').toLowerCase()}`;
```

(Generate this ID earlier in the loop, alongside the existing `chartId` generation)

Then in the HTML template, between the comparison bar and donut section, add:

```html
<div class="mt-4 pt-4 border-t border-gray-100" onclick="event.stopPropagation()">
  <div class="text-xs font-medium text-gray-500 mb-2">12-Week Trend</div>
  <div style="position: relative; height: 120px;">
    <canvas id="${trendChartId}"></canvas>
  </div>
</div>
```

Key details:

- `onclick="event.stopPropagation()"` prevents chart hover/click from triggering card's `openDetailPanel()` (Pitfall 2)
- `position: relative` + explicit height required for Chart.js responsive behavior (Pattern 3)
- `height: 120px` -- compact but readable (Claude's discretion per CONTEXT.md)
- Border-top divider matches existing card section separators
- "12-Week Trend" header text per CONTEXT.md requirement

**2. Create trend chart instances in the post-DOM rendering loop.**

After the existing doughnut chart creation loop (around lines 876-921), add trend chart creation in the SAME loop. The loop iterates `sortedUnits` and has access to `unitName`, `unitData`, etc.

Inside the existing `sortedUnits.forEach(...)` loop (or in a new loop immediately after), for each business unit:

```javascript
// Create trend chart
const trendChartId = `trend-${unitName.replace(/\s+/g, '-').toLowerCase()}`;
const trendData = buTrends[unitName] || [];
const trendChartInstance = createBUTrendChart(trendChartId, trendData);
if (trendChartInstance) {
  businessUnitTrendCharts[unitName] = trendChartInstance;
}
```

**Important:** The `trendChartId` generation must be IDENTICAL in both the HTML template and the chart creation code. Use the same `unitName.replace(/\s+/g, '-').toLowerCase()` pattern. Canvas IDs will be like `trend-south-carolina`, `trend-wyoming`, `trend-michigan`.

The `buTrends` variable is already extracted at the top of `renderBusinessUnits()` from `dashboardData.business_unit_trends` (added in Phase 1, commit 8a3de0e). The `trendData` variable is already available in the loop scope.
</action>
<verify>

1. Start the dev environment: `docker compose up -d` (if not already running)
2. Open http://localhost:8081/ in browser
3. Verify: each business unit card shows a "12-Week Trend" section with a line chart between the comparison bar and donut chart
4. Verify: chart has blue line with area fill
5. Verify: X-axis shows week labels (W1-W12)
6. Verify: hovering shows tooltip with subscriber count and change indicator
7. Verify: clicking on chart area does NOT open the detail panel
8. Check browser console for JavaScript errors -- should be none
9. Verify: chart resizes properly when browser window is resized
   </verify>
   <done>

- Each BU card displays a trend line chart between comparison bar and donut chart
- Chart canvas has unique ID (trend-south-carolina, trend-wyoming, trend-michigan)
- Chart instances are created after DOM insertion and stored in businessUnitTrendCharts
- Charts are responsive (fill card width on any screen size)
- Click on chart area does not trigger card onclick
- No JavaScript console errors
  </done>
  </task>

</tasks>

<verification>
**Full phase verification (run after both tasks complete):**

1. **Visual match (CHART-01):** BU trend charts have identical blue line (#3b82f6) and area fill (rgba(59,130,246,0.1)) as the company-wide trend chart at the top of the dashboard
2. **Week labels (CHART-02):** X-axis shows W1 through W12 labels along the bottom of each chart
3. **Tooltips (CHART-03):** Hovering over a data point shows tooltip with week label, subscriber count (formatted with commas), and color-coded change indicator (green positive, red negative)
4. **Auto-scaled Y-axis (CHART-04):** Each BU chart's Y-axis range is fitted to that BU's data (e.g., South Carolina ~3,100-3,120, Wyoming ~1,600-1,620) -- not scaled to company-wide totals
5. **Card position (CARD-01):** Chart sits between the comparison bar and the donut chart in each card
6. **Responsive width (CARD-02):** Charts fill the card width; resize the browser to verify they adapt
7. **Chart lifecycle:** Navigate away from dashboard and back -- charts should re-render cleanly without "Canvas already in use" warnings
8. **Click isolation:** Clicking on the chart area should NOT open the detail panel
9. **No data handling:** If a BU has no trend data, "No data available" message appears instead of empty chart
   </verification>

<success_criteria>

- All 3 business unit cards (South Carolina, Wyoming, Michigan) display a 12-week trend line chart
- Charts visually match the company-wide trend chart style (blue line + area fill)
- Tooltips show formatted subscriber counts with week-over-week change
- Charts are responsive and do not break card layout on any screen size
- No JavaScript errors in browser console
- Chart interactions (hover only) do not conflict with card click behavior
  </success_criteria>

<output>
After completion, create `.planning/phases/02-chart-rendering-and-card-integration/02-01-SUMMARY.md`
</output>
