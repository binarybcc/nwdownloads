# Database Migrations

This directory contains database schema migrations for the Circulation Dashboard.

## Migration System

**Hybrid Approach:**
- **SQL migrations** (000_*.sql, 001_*.sql, etc.) - Direct schema changes
- **PHP migrations** (YYYYMMDDHHMMSS_*.php) - Complex data transformations

## Migration Files

### SQL Migrations (Schema Changes)

**`000_create_migrations_table.sql`**
- Creates the `migrations` tracking table
- Must be run first to enable migration tracking

**`001_initial_schema.sql`**
- Creates core tables: `daily_snapshots`, `publication_schedule`
- Establishes primary keys and indexes
- Defines initial schema structure

**`005_create_churn_tables.sql`**
- Creates churn analysis tables
- Tracks subscriber losses and gains

### PHP Migrations (Data Transformations)

**`20251208134338_initial_schema.php`**
- PHP version of initial schema creation
- Uses Phinx migration framework

**`20251208134358_add_week_columns_to_daily_snapshots.php`**
- Adds `year` and `week_num` columns to `daily_snapshots`
- Backfills week data for existing records

**`20251208160000_add_source_tracking_for_soft_backfill.php`**
- Adds `data_source` ENUM column (manual, upload, backfill)
- Adds `upload_filename` for audit trail
- Enables tracking of how data entered system

## Running Migrations

### Development (Docker)

```bash
# Apply all SQL migrations manually
docker exec circulation_db mariadb \
  -ucirc_dash -p"Barnaby358@Jones!" -D circulation_dashboard \
  < database/migrations/001_initial_schema.sql

# Or run via initialization script
docker compose down -v
docker compose up -d  # Runs init scripts automatically
```

### Production (Synology NAS)

```bash
# SSH into production
sshpass -p 'Mojave48ice' ssh it@192.168.1.254

# Apply migration manually
mysql -uroot -p'P@ta675N0id' -S /run/mysqld/mysqld10.sock circulation_dashboard \
  < /volume1/homes/it/circulation-deploy/database/migrations/005_create_churn_tables.sql
```

## Migration Naming Convention

**SQL Files:**
- Format: `NNN_description.sql` (where NNN is sequence number)
- Examples: `001_initial_schema.sql`, `005_create_churn_tables.sql`

**PHP Files (Phinx):**
- Format: `YYYYMMDDHHMMSS_description.php`
- Auto-generated by: `vendor/bin/phinx create MyMigration`

## Creating New Migrations

### SQL Migration (Recommended for Simple Changes)

1. Create file: `database/migrations/006_add_new_column.sql`
2. Write SQL:
   ```sql
   -- Add column to daily_snapshots
   ALTER TABLE daily_snapshots
     ADD COLUMN new_metric INT DEFAULT 0;
   ```
3. Test in Development first
4. Apply to Production after verification

### PHP Migration (For Complex Transformations)

1. Generate migration:
   ```bash
   vendor/bin/phinx create AddNewMetric
   ```
2. Edit generated file in `database/migrations/`
3. Implement `up()` and `down()` methods
4. Run: `vendor/bin/phinx migrate`

## Migration Tracking

The `migrations` table tracks which migrations have been applied:
```sql
SELECT * FROM migrations ORDER BY migration_id;
```

## Best Practices

1. **Test migrations in Development first** - Never run untested migrations in Production
2. **Make migrations idempotent** - Safe to run multiple times
3. **Include rollback logic** - Always plan how to undo changes
4. **Document data impact** - Note how much data will be affected
5. **Backup before production migration** - Always have a restore point

## Rollback Strategy

**For SQL migrations:**
- Write inverse operations in separate file (e.g., `006_revert_add_new_column.sql`)

**For PHP migrations:**
- Implement `down()` method in migration class
- Run: `vendor/bin/phinx rollback`

## Current Schema Version

Check latest applied migration:
```sql
SELECT MAX(version) as current_version FROM migrations;
```

## Documentation

See `/docs/KNOWLEDGE-BASE.md` for complete database schema documentation.
