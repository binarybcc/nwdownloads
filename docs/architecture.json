{
  "metadata": {
    "version": "1.0.0",
    "last_updated": "2025-12-07T21:45:00Z",
    "purpose": "System architecture and database schemas for AI reference"
  },
  "system_architecture": {
    "pattern": "3-tier architecture",
    "tiers": {
      "presentation": {
        "technology": "Vanilla JavaScript + Tailwind CSS",
        "entry_point": "index.php (38KB HTML + embedded PHP)",
        "state_management": "CircDashboard namespace (centralized singleton)",
        "components": ["Dashboard", "Charts", "DetailPanel", "TrendSlider", "SubscriberTable"]
      },
      "application": {
        "technology": "PHP 8.2 REST API",
        "entry_point": "api.php (1,783 lines)",
        "authentication": "Newzware credentials via auth_check.php",
        "data_upload": "upload.php (628 lines with UPSERT logic)"
      },
      "data": {
        "technology": "MariaDB 10.11",
        "primary_table": "daily_snapshots",
        "indexes": ["(snapshot_date, paper_code) PRIMARY KEY", "date index", "paper_code index"],
        "performance": "<100ms query time for most operations"
      }
    },
    "data_flow": {
      "csv_import": "CSV → upload.php → UPSERT → daily_snapshots table → confirmation",
      "dashboard_render": "Browser → index.php → api.php?action=overview → SQL aggregation → JSON → Chart.js",
      "drill_down": "Chart click → Context menu → TrendSlider/DetailPanel → api.php → subscriber data"
    }
  },
  "database_schema": {
    "daily_snapshots": {
      "purpose": "Primary circulation data storage",
      "primary_key": "(snapshot_date, paper_code)",
      "indexes": {
        "primary": "(snapshot_date, paper_code)",
        "date_idx": "snapshot_date",
        "paper_idx": "paper_code",
        "business_unit_idx": "business_unit"
      },
      "columns": {
        "snapshot_date": {
          "type": "DATE",
          "description": "Date of circulation snapshot",
          "example": "2025-12-07"
        },
        "paper_code": {
          "type": "VARCHAR(10)",
          "description": "Publication code",
          "values": ["TJ", "TA", "TR", "LJ", "WRN", "FN"]
        },
        "paper_name": {
          "type": "VARCHAR(100)",
          "description": "Full publication name"
        },
        "business_unit": {
          "type": "VARCHAR(50)",
          "description": "Business unit",
          "values": ["Wyoming", "Michigan", "South Carolina"]
        },
        "total_active": {
          "type": "INT",
          "description": "Count of all active subscribers"
        },
        "deliverable": {
          "type": "INT",
          "description": "total_active minus on_vacation",
          "formula": "total_active - on_vacation"
        },
        "mail_delivery": {
          "type": "INT",
          "description": "Subscribers with MAIL delivery type"
        },
        "carrier_delivery": {
          "type": "INT",
          "description": "Subscribers with CARR delivery type"
        },
        "digital_only": {
          "type": "INT",
          "description": "Subscribers with INTE (internet) delivery"
        },
        "on_vacation": {
          "type": "INT",
          "description": "Subscribers with VAC in zone (vacation hold)"
        },
        "created_at": {
          "type": "TIMESTAMP",
          "description": "Record creation timestamp"
        },
        "updated_at": {
          "type": "TIMESTAMP",
          "description": "Last update timestamp (for UPSERT tracking)"
        }
      },
      "current_count": 250,
      "date_range": "2025-01-01 onwards",
      "upsert_logic": "ON DUPLICATE KEY UPDATE (week-based precedence)"
    },
    "publication_schedule": {
      "purpose": "Print and digital publication days by paper",
      "primary_key": "paper_code",
      "columns": {
        "paper_code": {"type": "VARCHAR(10)", "description": "Publication code"},
        "print_days": {"type": "VARCHAR(50)", "description": "Days paper prints", "example": "Wednesday,Saturday"},
        "digital_days": {"type": "VARCHAR(50)", "description": "Days digital edition published"}
      },
      "seed_data": "Loaded via 02_seed_publication_schedule.sql"
    },
    "subscriber_snapshots": {
      "purpose": "Individual subscriber-level records (new table added Dec 6)",
      "note": "Used for detailed drill-down beyond daily aggregates",
      "documentation_status": "Underdocumented - needs schema reference"
    }
  },
  "frontend_architecture": {
    "state_pattern": "Centralized singleton (CircDashboard namespace)",
    "state_object": {
      "location": "window.CircDashboard.state",
      "structure": {
        "dashboardData": "Current snapshot data from API",
        "dataRange": {"min_date": "string", "max_date": "string"},
        "currentDate": "Selected week (null = current)",
        "compareMode": "week_over_week | month_over_month | year_over_year",
        "charts": {
          "trend": "Chart.js instance",
          "delivery": "Chart.js instance",
          "businessUnits": "Object of Chart instances"
        },
        "flatpickrInstance": "Date picker instance"
      }
    },
    "benefits": [
      "Single source of truth (no scattered globals)",
      "Easy debugging (console.log(CircDashboard.state))",
      "No race conditions between modules",
      "Clean teardown/refresh"
    ],
    "module_structure": {
      "load_order_critical": true,
      "files_in_order": [
        {"order": 1, "file": "app.js", "size_lines": 1525, "purpose": "Core state + API + render"},
        {"order": 2, "file": "state-icons.js", "size_lines": 150, "purpose": "State abbreviation mappings"},
        {"order": 3, "file": "chart-layout-manager.js", "size_lines": 200, "purpose": "Responsive sizing"},
        {"order": 4, "file": "donut-to-state-animation.js", "size_lines": 250, "purpose": "Animated transitions"},
        {"order": 5, "file": "detail_panel.js", "size_lines": 900, "purpose": "Detail view rendering"},
        {"order": 6, "file": "ui-enhancements.js", "size_lines": 200, "purpose": "Keyboard shortcuts + a11y"},
        {"order": 7, "file": "context-menu.js", "size_lines": 300, "purpose": "Right-click handlers"},
        {"order": 8, "file": "export-utils.js", "size_lines": 250, "purpose": "Excel/CSV export"},
        {"order": 9, "file": "subscriber-table-panel.js", "size_lines": 500, "purpose": "Subscriber list drill-down"},
        {"order": 10, "file": "trend-slider.js", "size_lines": 759, "purpose": "Historical trend viz"},
        {"order": 11, "file": "chart-context-integration.js", "size_lines": 200, "purpose": "Wire everything (MUST BE LAST)"}
      ],
      "critical_rule": "chart-context-integration.js MUST load after trend-slider.js or click handlers fail"
    },
    "event_system": {
      "DashboardRendered": {
        "dispatched_by": "renderDashboard() in app.js (line 409)",
        "listened_by": "index.php initialization code",
        "purpose": "Replaces setTimeout(500) race condition",
        "benefit": "Guaranteed UI initialization timing"
      }
    },
    "chart_interaction_system": {
      "entry_point": "Right-click any chart bar",
      "context_menu_options": [
        {"label": "View Historical Trend", "action": "Opens TrendSlider with 4/8/12/52 week options"},
        {"label": "View Subscribers", "action": "Opens SubscriberTablePanel with exportable list"},
        {"label": "Export Data", "action": "CSV/Excel/PDF export"}
      ],
      "keyboard_shortcuts": {
        "Ctrl+K": "Open export menu",
        "Cmd+K": "Open export menu (Mac)",
        "ESC": "Close trend slider or detail panel",
        "Arrow keys": "Navigate time ranges in trend slider"
      },
      "color_continuity": "Trend chart uses same color as source bar for visual consistency"
    }
  },
  "api_endpoints": {
    "base_url": "api.php",
    "authentication": "Session-based (requires auth_check.php)",
    "endpoints": {
      "overview": {
        "action": "overview",
        "parameters": {"date": "optional YYYY-MM-DD"},
        "returns": "Daily snapshot with comparisons (current vs previous period)",
        "use_case": "Main dashboard data"
      },
      "weekly_summary": {
        "action": "weekly_summary",
        "parameters": {"year": "required", "week": "required"},
        "returns": "Aggregated weekly data",
        "use_case": "Trend analysis"
      },
      "business_unit_detail": {
        "action": "business_unit_detail",
        "parameters": {"unit": "required", "date": "optional"},
        "returns": "Unit-specific breakdown with papers",
        "use_case": "Detail panel data"
      },
      "paper_detail": {
        "action": "paper_detail",
        "parameters": {"code": "required (TJ/TA/TR/LJ/WRN)", "date": "optional"},
        "returns": "Paper-specific metrics",
        "use_case": "Paper drill-down"
      },
      "subscription_lengths": {
        "action": "subscription_lengths",
        "parameters": {"unit": "required", "date": "optional"},
        "returns": "Rate codes with subscriber counts",
        "use_case": "Subscription detail charts",
        "normalization": "12M, 1Y, 52Wk treated as same (1 Year)"
      },
      "get_trend": {
        "action": "get_trend",
        "parameters": {
          "type": "required (business_unit | paper | delivery_type)",
          "metric": "required",
          "time_range": "required (4 | 8 | 12 | 52 weeks)"
        },
        "returns": "Historical data points for trend visualization",
        "use_case": "TrendSlider component"
      },
      "view_subscribers": {
        "action": "view_subscribers",
        "parameters": {"unit": "required", "metric_type": "optional"},
        "returns": "Subscriber list (max 10,000 rows)",
        "use_case": "SubscriberTablePanel",
        "exportable": true
      }
    },
    "security": {
      "sql_injection_prevention": "PDO prepared statements (all queries)",
      "authentication": "Newzware credentials checked via auth_check.php",
      "session_timeout": "7200 seconds (2 hours)",
      "brute_force_protection": "brute_force_protection.php"
    }
  },
  "docker_architecture": {
    "development": {
      "compose_file": "docker-compose.yml",
      "services": {
        "database": {
          "image": "mariadb:10.11",
          "container_name": "circulation_db",
          "environment_vars_from": ".env file",
          "volumes": ["db_data:/var/lib/mysql", "./db_init:/docker-entrypoint-initdb.d:ro"],
          "healthcheck": "healthcheck.sh --connect --innodb_initialized"
        },
        "web": {
          "image": "binarybcc/nwdownloads-circ:latest",
          "container_name": "circulation_web",
          "depends_on": "database (with health check)",
          "volumes": ["./web:/var/www/html (LIVE CODE EDITING)", "./hotfolder:/var/www/hotfolder:ro"],
          "ports": ["8081:80"]
        }
      },
      "network": "circulation_network (bridge)",
      "key_feature": "Volume mounts allow live code editing without rebuild"
    },
    "production": {
      "compose_file": "docker-compose.prod.yml",
      "services": {
        "database": "Same as development",
        "web": {
          "image": "binarybcc/nwdownloads-circ:latest",
          "volumes": "NONE (code baked into image)",
          "environment_vars": "Hardcoded in docker-compose.prod.yml (NOT from .env)"
        }
      },
      "deployment_location": "/volume1/docker/nwdownloads on Synology NAS",
      "key_feature": "Immutable infrastructure - code cannot be edited in place"
    },
    "multi_platform_support": {
      "platforms": ["linux/amd64", "linux/arm64"],
      "build_tool": "docker buildx",
      "manifest": "Multi-arch manifest on Docker Hub",
      "auto_selection": "Docker pulls correct architecture automatically"
    }
  },
  "week_calculation": {
    "standard": "ISO 8601 with Sunday start",
    "implementation": "SQL: YEARWEEK(snapshot_date, 0) where 0 = Sunday start",
    "special_case": "Monday snapshots assigned to previous week",
    "boundary_logic": "Sunday-Saturday weeks",
    "comparison_logic": {
      "week_over_week": "Current week vs same week last year",
      "month_over_month": "Current month vs previous month",
      "year_over_year": "Current year total vs previous year total"
    }
  },
  "performance_characteristics": {
    "database": {
      "query_time": "<100ms for most operations",
      "csv_import_time": "10-30 seconds for ~8,000 rows",
      "primary_key_lookup": "O(1) via (snapshot_date, paper_code)",
      "index_usage": "All major queries use indexes"
    },
    "frontend": {
      "page_load_first_visit": "2-3 seconds",
      "page_load_cached": "<500ms",
      "chart_render_time": "~100ms per chart",
      "total_assets": "~150KB JS + 21KB CSS"
    },
    "docker": {
      "container_startup": "~5 seconds for web, ~30 seconds for database",
      "multi_arch_performance": "Native execution (no emulation overhead)"
    }
  },
  "architectural_patterns": {
    "upsert_strategy": {
      "pattern": "INSERT ... ON DUPLICATE KEY UPDATE",
      "key": "(snapshot_date, paper_code)",
      "behavior": "Week-based precedence (later day-of-week wins)",
      "transactional": "All-or-nothing via PDO transactions"
    },
    "state_management": {
      "pattern": "Centralized singleton",
      "implementation": "CircDashboard namespace",
      "benefits": ["No scattered globals", "Easy debugging", "Single source of truth"]
    },
    "event_coordination": {
      "pattern": "Custom DOM events",
      "example": "DashboardRendered event",
      "benefit": "Explicit dependencies vs magic number timeouts"
    },
    "css_strategy": {
      "pattern": "Utility-first (Tailwind)",
      "build": "Pre-compiled to output.css (21KB)",
      "no_runtime": "Zero runtime compilation"
    }
  },
  "critical_file_locations": {
    "api": "/web/api.php (1,783 lines)",
    "upload": "/web/upload.php (628 lines)",
    "dashboard": "/web/index.php (38KB)",
    "auth": "/web/auth_check.php",
    "config": "/web/config.php",
    "main_js": "/web/assets/app.js (1,525 lines)",
    "trend_viz": "/web/assets/trend-slider.js (759 lines)",
    "db_init": "/db_init/*.sql",
    "docker_build": "/Dockerfile",
    "build_script": "/build-and-push.sh"
  }
}
