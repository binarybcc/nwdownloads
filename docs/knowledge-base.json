{
  "metadata": {
    "version": "1.0.0",
    "last_updated": "2025-12-07T21:40:00Z",
    "purpose": "AI-optimized project knowledge base for Claude context",
    "format": "structured_json",
    "ai_consumption": true
  },
  "project": {
    "name": "NWDownloads Circulation Dashboard",
    "version": "1.8.1",
    "type": "newspaper_circulation_analytics",
    "status": "production",
    "repositories": {
      "github": "https://github.com/binarybcc/nwdownloads",
      "docker_hub": "binarybcc/nwdownloads-circ"
    }
  },
  "tech_stack": {
    "backend": {
      "language": "PHP",
      "version": "8.2",
      "server": "Apache 2.4",
      "framework": "none (vanilla PHP)"
    },
    "frontend": {
      "language": "JavaScript (vanilla ES6+)",
      "css": "Tailwind CSS 3.4 (21KB optimized)",
      "charting": "Chart.js 4.4",
      "date_picker": "Flatpickr",
      "export": ["XLSX", "jsPDF", "html2canvas"]
    },
    "database": {
      "engine": "MariaDB",
      "version": "10.11",
      "primary_table": "daily_snapshots",
      "record_count": 250,
      "data_range": "2025-01-01 onwards"
    },
    "infrastructure": {
      "containerization": "Docker + Docker Compose",
      "registry": "Docker Hub",
      "platforms": ["linux/amd64", "linux/arm64"],
      "environment_mgmt": "direnv (.envrc)"
    }
  },
  "business_context": {
    "purpose": "Track newspaper circulation across multiple publications",
    "business_units": ["Wyoming", "Michigan", "South Carolina"],
    "publications": [
      {"code": "TJ", "name": "The Journal", "location": "Wyoming/South Carolina"},
      {"code": "TA", "name": "The Advertiser", "location": "Michigan"},
      {"code": "TR", "name": "The Ranger", "location": "Wyoming"},
      {"code": "LJ", "name": "Lander Journal", "location": "Wyoming"},
      {"code": "WRN", "name": "Wind River News", "location": "Wyoming"}
    ],
    "excluded_papers": ["FN (Former News - sold/discontinued)"],
    "subscriber_count": {
      "total": 8100,
      "wyoming": 1610,
      "michigan": 2909,
      "south_carolina": 3106
    },
    "delivery_types": {
      "mail": "90% (USPS)",
      "digital": "5% (Internet)",
      "carrier": "5% (Local carrier)"
    }
  },
  "data_state": {
    "current_snapshot": {
      "record_count": 250,
      "date_range": "2025-01-01 onwards",
      "reason_for_limited_history": "Rate system changed Jan 2025, pre-2025 data incomparable"
    },
    "data_cleanup": {
      "date": "2025-12-02",
      "action": "Deleted all pre-2025 data",
      "rationale": "Old subscription rates retired, making 2024 data incomplete/inaccurate",
      "impact": "2026 will be first year with valid year-over-year comparisons"
    },
    "import_frequency": "Weekly (recommended: Saturday)",
    "import_method": "CSV upload via upload.html"
  },
  "critical_architecture_decisions": {
    "docker_hub_hybrid": {
      "decision": "Development uses volume mounts, Production uses pre-built images",
      "rationale": "Fast iteration in dev, stability in prod",
      "date": "2025-12",
      "status": "active"
    },
    "week_based_uploads": {
      "decision": "Later day-of-week data replaces earlier in same week",
      "rationale": "Prevents accidental overwrite of better data with stale snapshots",
      "date": "2025-12",
      "implementation": "upload.php lines 412-484"
    },
    "multi_platform_builds": {
      "decision": "Build native images for AMD64 and ARM64",
      "rationale": "Eliminate QEMU emulation overhead on NAS",
      "date": "2025-12-07",
      "performance_gain": "10-30%"
    },
    "event_based_ui": {
      "decision": "Replace setTimeout(500) with DashboardRendered event",
      "rationale": "Eliminate race conditions on slow connections",
      "date": "2025-12-07",
      "found_by": "Gemini code review"
    }
  },
  "deployment": {
    "environments": {
      "development": {
        "location": "Local machine (OrbStack/Docker Desktop)",
        "url": "http://localhost:8081/",
        "docker_compose": "docker-compose.yml",
        "features": ["volume mounts", "live code editing"],
        "database": "Local MariaDB container"
      },
      "production": {
        "location": "Synology NAS 192.168.1.254",
        "path": "/volume1/docker/nwdownloads",
        "url": "http://192.168.1.254:8081/",
        "docker_compose": "docker-compose.prod.yml",
        "features": ["pre-built Docker images", "no volume mounts"],
        "ssh_credentials": {
          "host": "192.168.1.254",
          "user": "it",
          "password": "Mojave48ice"
        }
      }
    },
    "workflow": {
      "steps": [
        "1. Make changes in Development (volume mounts allow live editing)",
        "2. Test at http://localhost:8081/",
        "3. Commit to Git and push to GitHub",
        "4. Run ./build-and-push.sh (builds multi-platform, pushes to Docker Hub)",
        "5. SSH to NAS: sshpass -p 'Mojave48ice' ssh it@192.168.1.254",
        "6. cd /volume1/docker/nwdownloads",
        "7. sudo /usr/local/bin/docker compose -f docker-compose.prod.yml pull",
        "8. sudo /usr/local/bin/docker compose -f docker-compose.prod.yml up -d",
        "9. Verify at http://192.168.1.254:8081/"
      ],
      "critical_rules": [
        "NEVER make changes directly in Production",
        "ALWAYS test in Development first",
        "NEVER copy code files to Production (deploy via Docker Hub only)",
        "Configuration files only via SSH (docker-compose.prod.yml, db_init scripts)"
      ]
    }
  },
  "database_credentials": {
    "development": {
      "root_password": "RootPassword456!",
      "app_user": "circ_dash",
      "app_password": "Barnaby358@Jones!",
      "database": "circulation_dashboard"
    },
    "production": {
      "note": "Uses same credentials but hardcoded in docker-compose.prod.yml",
      "root_password": "RootPassword456!",
      "app_user": "circ_dash",
      "app_password": "Barnaby358@Jones!"
    },
    "hostname": {
      "from_container": "database (Docker Compose service name)",
      "not_ip": "DO NOT use IP addresses - use service name 'database'"
    }
  },
  "common_operations": {
    "upload_csv": {
      "url": "http://localhost:8081/upload.html (dev) or http://192.168.1.254:8081/upload.html (prod)",
      "file_format": "AllSubscriberReport*.csv from Newzware",
      "processing_time": "10-30 seconds for ~8000 rows",
      "required_columns": ["Ed (paper code)", "ISS (issue date)", "DEL (delivery type)"]
    },
    "check_database": {
      "command": "docker exec circulation_db mariadb -uroot -pRootPassword456! -D circulation_dashboard -e 'SELECT COUNT(*) FROM daily_snapshots;'",
      "expected_output": "~250 rows"
    },
    "view_logs": {
      "all": "docker compose logs -f",
      "web_only": "docker compose logs -f web",
      "database_only": "docker compose logs -f database"
    },
    "restart_containers": "docker compose restart"
  },
  "week_based_upload_rules": {
    "precedence": "Later day-of-week wins",
    "day_order": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"],
    "rules": {
      "saturday_replaces_friday": true,
      "friday_replaces_thursday": true,
      "tuesday_rejected_if_friday_exists": true,
      "same_day_overwrites": true
    },
    "rationale": "Later-in-week snapshots capture more complete weekly activity",
    "implementation": "upload.php uses ISO day-of-week mapping (Monday=1, Sunday=7)",
    "special_case": "Monday uploads assigned to previous week's Saturday"
  },
  "recent_changes": {
    "2025-12-07": {
      "commit": "ad8eca6 and d7abf1e",
      "changes": [
        "Multi-platform Docker builds (AMD64 + ARM64)",
        "Fixed setTimeout race condition (event-based)",
        "Environment variable migration (.env)",
        "Week-based upload precedence system",
        "Build script line ending fix"
      ],
      "docker_image_digest": "sha256:4f9b0196f4ae8356bf102ac43f4f945227594cd24a58e35f854f5a9490ca7110"
    },
    "2025-12-06": {
      "changes": [
        "Chart interactions system refactored",
        "TrendSlider component (759 lines)",
        "Replaced ChartTransitionManager"
      ]
    },
    "2025-12-02": {
      "changes": [
        "Data cleanup - deleted all pre-2025 data",
        "Reason: Rate system change made historical data incomparable"
      ]
    }
  },
  "known_issues": {
    "pre_2025_data": {
      "issue": "No historical data before Jan 2025",
      "reason": "Rate system changed, old data incomparable",
      "resolution": "Intentional - not a bug",
      "impact": "No year-over-year comparisons until 2026"
    },
    "fn_orphan_records": {
      "issue": "351 orphan FN (Former News) records",
      "reason": "Newspaper sold, not cleaned from database",
      "resolution": "Excluded from dashboard display",
      "impact": "None - filtered out in queries"
    }
  },
  "file_organization": {
    "root_files": {
      "build-and-push.sh": "Multi-platform Docker build script",
      "docker-compose.yml": "Development config (volume mounts)",
      "docker-compose.prod.yml": "Production config (Docker Hub images)",
      "Dockerfile": "Web container build definition",
      ".envrc": "direnv config (auto-sets PROJECT_ROOT)",
      ".env": "Environment variables (NOT committed)",
      ".env.example": "Environment template"
    },
    "directories": {
      "/web/": "PHP application and API",
      "/web/assets/": "Frontend JavaScript and CSS (11 JS files)",
      "/sql/": "Database schema files",
      "/db_init/": "Database initialization scripts",
      "/docs/": "Documentation (now includes JSON knowledge base)",
      "/queries/": "CSV data files",
      "/archives/": "Archived files (CSVs, old docs, legacy templates)",
      "/tests/": "Test infrastructure (Vitest)"
    },
    "javascript_load_order": [
      "1. app.js (core state + utilities) - MUST load first",
      "2. state-icons.js",
      "3-9. Feature modules",
      "10. trend-slider.js",
      "11. chart-context-integration.js - MUST load last"
    ]
  },
  "ai_consumption_notes": {
    "purpose": "This file is optimized for AI parsing, not human readability",
    "usage": "Reference this file for quick project context",
    "update_frequency": "After major changes or deployments",
    "cross_references": {
      "architecture": "architecture.json",
      "deployment": "deployment-procedures.json",
      "troubleshooting": "troubleshooting-rules.json"
    }
  }
}
