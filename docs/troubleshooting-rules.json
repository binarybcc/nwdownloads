{
  "metadata": {
    "version": "1.0.0",
    "last_updated": "2025-12-07T21:55:00Z",
    "purpose": "Decision tree troubleshooting guide for common issues",
    "format": "symptom → diagnosis → solution"
  },
  "troubleshooting_trees": {
    "dashboard_wont_load": {
      "symptom": "Dashboard at http://localhost:8081 or http://192.168.1.254:8081 won't load",
      "decision_tree": [
        {
          "check": "Does 'docker compose ps' show containers running?",
          "if_no": {
            "diagnosis": "Containers not running",
            "solutions": [
              {
                "solution": "Start containers",
                "commands": {
                  "development": "docker compose up -d",
                  "production": "sudo /usr/local/bin/docker compose -f docker-compose.prod.yml up -d"
                }
              },
              {
                "solution": "Check logs for startup errors",
                "commands": {
                  "development": "docker compose logs",
                  "production": "sudo /usr/local/bin/docker logs circulation_web"
                }
              }
            ]
          },
          "if_yes": {
            "check": "Is circulation_db status 'healthy'?",
            "if_no": {
              "diagnosis": "Database container unhealthy",
              "solutions": [
                {
                  "solution": "Wait 30 seconds for database initialization",
                  "note": "First startup takes ~30 seconds"
                },
                {
                  "solution": "Check database logs",
                  "command": "docker compose logs database",
                  "look_for": "mariadbd: ready for connections"
                },
                {
                  "solution": "Restart database container",
                  "command": "docker compose restart database"
                }
              ]
            },
            "if_yes": {
              "check": "Is port 8081 accessible?",
              "test": "curl http://localhost:8081 (or appropriate host)",
              "if_no": {
                "diagnosis": "Port binding issue",
                "solutions": [
                  {
                    "solution": "Check if port 8081 is already in use",
                    "command": "lsof -i :8081 OR netstat -an | grep 8081"
                  },
                  {
                    "solution": "Verify port mapping in docker-compose.yml",
                    "check_for": "ports: - \"8081:80\""
                  },
                  {
                    "solution": "Restart web container",
                    "command": "docker compose restart web"
                  }
                ]
              },
              "if_yes": {
                "diagnosis": "Application error",
                "solutions": [
                  {
                    "solution": "Check web container logs",
                    "command": "docker compose logs web --tail 100",
                    "look_for": ["PHP errors", "Apache errors", "500 status codes"]
                  },
                  {
                    "solution": "Check browser console for JavaScript errors",
                    "action": "Open browser DevTools (F12) → Console tab"
                  }
                ]
              }
            }
          }
        }
      ]
    },
    "database_connection_failed": {
      "symptom": "API returns 'Database connection failed' or similar error",
      "decision_tree": [
        {
          "check": "Is database container running and healthy?",
          "command": "docker compose ps",
          "if_no": {
            "diagnosis": "Database container not running",
            "solution": "See 'dashboard_wont_load' troubleshooting tree"
          },
          "if_yes": {
            "check": "Can web container reach database?",
            "test_command": "docker exec circulation_web php -r \"\\$pdo = new PDO('mysql:host=database;dbname=circulation_dashboard', 'circ_dash', 'Barnaby358@Jones!'); echo 'Connected!';\"",
            "if_no": {
              "diagnosis": "Network connectivity issue",
              "solutions": [
                {
                  "solution": "Verify database hostname in config.php",
                  "correct_value": "database (NOT localhost, NOT IP address)",
                  "file": "web/config.php"
                },
                {
                  "solution": "Check Docker network",
                  "command": "docker network ls",
                  "look_for": "circulation_network"
                },
                {
                  "solution": "Recreate containers",
                  "command": "docker compose down && docker compose up -d"
                }
              ]
            },
            "if_yes": {
              "check": "Are credentials correct?",
              "credentials": {
                "development": {
                  "host": "database",
                  "user": "circ_dash",
                  "password": "Barnaby358@Jones!",
                  "database": "circulation_dashboard"
                },
                "production": {
                  "host": "database",
                  "user": "circ_dash",
                  "password": "Barnaby358@Jones!",
                  "database": "circulation_dashboard"
                }
              },
              "if_no": {
                "diagnosis": "Credential mismatch",
                "solutions": [
                  {
                    "solution": "Update .env file (development)",
                    "file": ".env",
                    "verify": "DB_HOST=database, DB_USER=circ_dash, DB_PASSWORD=Barnaby358@Jones!"
                  },
                  {
                    "solution": "Update docker-compose.prod.yml (production)",
                    "file": "docker-compose.prod.yml",
                    "note": "Production uses hardcoded values, NOT .env"
                  },
                  {
                    "solution": "Recreate containers after changes",
                    "command": "docker compose up -d --force-recreate"
                  }
                ]
              }
            }
          }
        }
      ]
    },
    "csv_upload_fails": {
      "symptom": "CSV upload fails or shows error message",
      "decision_tree": [
        {
          "check": "What is the error message?",
          "options": {
            "csv_does_not_appear_to_be_all_subscriber_report": {
              "diagnosis": "CSV format validation failed",
              "causes": [
                "Wrong CSV file (not All Subscriber Report)",
                "Missing required columns (Ed, ISS, DEL)"
              ],
              "solutions": [
                {
                  "solution": "Verify CSV is from Newzware All Subscriber Report query",
                  "required_columns": ["Ed (paper code)", "ISS (issue date)", "DEL (delivery type)"]
                },
                {
                  "solution": "Check CSV has data rows (not just headers)",
                  "action": "Open CSV and verify subscriber rows exist"
                },
                {
                  "solution": "Re-export from Newzware",
                  "steps": [
                    "1. Log in to Newzware Ad-Hoc Query Builder",
                    "2. Run 'All Subscriber Report' query",
                    "3. Export as CSV",
                    "4. Try upload again"
                  ]
                }
              ]
            },
            "no_valid_data_found": {
              "diagnosis": "CSV parsed but no valid records",
              "causes": [
                "All dates are pre-2025 (filtered out)",
                "No active subscribers in export",
                "Data format issues"
              ],
              "solutions": [
                {
                  "solution": "Check snapshot dates in CSV",
                  "note": "Only 2025-01-01 onwards is imported (pre-2025 excluded due to rate system change)"
                },
                {
                  "solution": "Verify CSV has active subscribers",
                  "check": "Ed column should have TJ, TA, TR, LJ, WRN values"
                },
                {
                  "solution": "Check upload.php logs",
                  "command": "docker compose logs web | grep upload"
                }
              ]
            },
            "later_in_week_data_exists": {
              "diagnosis": "Week-based precedence rejection",
              "explanation": "Later-in-week data cannot be overwritten by earlier-in-week data",
              "is_this_an_error": "NO - This is expected behavior",
              "week_precedence_rules": {
                "saturday_replaces_friday": true,
                "friday_replaces_thursday": true,
                "tuesday_rejected_if_friday_exists": true,
                "same_day_overwrites": true,
                "monday_assigned_to_previous_week": true
              },
              "solutions": [
                {
                  "solution": "Use Saturday reports for weekly snapshots",
                  "rationale": "Saturday captures full week's activity"
                },
                {
                  "solution": "Re-upload same day or later day-of-week",
                  "examples": [
                    "Can replace Friday with Saturday ✅",
                    "Can replace Friday with Friday ✅",
                    "Cannot replace Friday with Tuesday ❌"
                  ]
                },
                {
                  "solution": "Document which day reports are uploaded",
                  "recommendation": "Establish consistent weekly upload schedule (e.g., every Saturday)"
                }
              ]
            },
            "file_too_large": {
              "diagnosis": "File exceeds upload limit",
              "current_limit": "10 MB",
              "solutions": [
                {
                  "solution": "Check file size",
                  "command": "ls -lh AllSubscriberReport*.csv"
                },
                {
                  "solution": "Compress CSV if needed",
                  "note": "Typical All Subs report: ~1-2 MB for 8,000 rows"
                },
                {
                  "solution": "Increase PHP upload limits if legitimate",
                  "files": ["php.ini: upload_max_filesize", "php.ini: post_max_size"]
                }
              ]
            },
            "processing_timeout": {
              "diagnosis": "Upload times out during processing",
              "normal_processing_time": "10-30 seconds for ~8,000 rows",
              "solutions": [
                {
                  "solution": "Check web container logs",
                  "command": "docker compose logs web --tail 100"
                },
                {
                  "solution": "Verify database is responsive",
                  "test": "docker exec circulation_db mariadb -uroot -pRootPassword456! -e 'SELECT 1;'"
                },
                {
                  "solution": "Increase PHP timeout if needed",
                  "file": "php.ini: max_execution_time"
                }
              ]
            }
          }
        }
      ]
    },
    "charts_not_rendering": {
      "symptom": "Dashboard loads but charts don't appear",
      "decision_tree": [
        {
          "check": "Open browser console (F12) - are there JavaScript errors?",
          "if_yes": {
            "diagnosis": "JavaScript error preventing chart rendering",
            "common_errors": {
              "chart_js_not_loaded": {
                "error": "Chart is not defined",
                "solution": "Verify Chart.js CDN is accessible",
                "file": "index.php (check <script> tags)"
              },
              "circDashboard_undefined": {
                "error": "CircDashboard is not defined",
                "solution": "Check app.js loaded before other scripts",
                "load_order": "app.js MUST load first"
              },
              "api_call_failed": {
                "error": "Failed to fetch or 500 error",
                "solution": "Check API endpoint",
                "test": "Open http://localhost:8081/api.php?action=overview in browser"
              }
            }
          },
          "if_no": {
            "check": "Is there data in the database?",
            "test_command": "docker exec circulation_db mariadb -ucirc_dash -p'Barnaby358@Jones!' -D circulation_dashboard -e 'SELECT COUNT(*) FROM daily_snapshots;'",
            "if_no": {
              "diagnosis": "No data to display",
              "solution": "Upload CSV data via http://localhost:8081/upload.html"
            },
            "if_yes": {
              "check": "Does API return data?",
              "test": "curl http://localhost:8081/api.php?action=overview",
              "if_no": {
                "diagnosis": "API error",
                "solutions": [
                  {
                    "solution": "Check web container logs",
                    "command": "docker compose logs web --tail 50"
                  },
                  {
                    "solution": "Verify database connection",
                    "see": "database_connection_failed troubleshooting tree"
                  }
                ]
              },
              "if_yes": {
                "diagnosis": "Frontend rendering issue",
                "solutions": [
                  {
                    "solution": "Hard refresh browser",
                    "shortcuts": "Ctrl+Shift+R (Windows/Linux) or Cmd+Shift+R (Mac)"
                  },
                  {
                    "solution": "Clear browser cache",
                    "action": "Clear site data in browser settings"
                  },
                  {
                    "solution": "Check for DashboardRendered event",
                    "file": "app.js line 409",
                    "verify": "document.dispatchEvent(new Event('DashboardRendered'));"
                  }
                ]
              }
            }
          }
        }
      ]
    },
    "docker_build_fails": {
      "symptom": "build-and-push.sh or docker build fails",
      "decision_tree": [
        {
          "check": "What is the error message?",
          "options": {
            "cannot_connect_to_docker_daemon": {
              "error": "Cannot connect to the Docker daemon",
              "diagnosis": "Docker not running",
              "solutions": [
                {
                  "solution": "Start Docker Desktop",
                  "platforms": ["macOS", "Windows"]
                },
                {
                  "solution": "Check Docker service",
                  "command": "docker info"
                }
              ]
            },
            "copy_failed_no_such_file": {
              "error": "COPY failed: no such file or directory",
              "diagnosis": "Not in project root or missing files",
              "solutions": [
                {
                  "solution": "Ensure in project root directory",
                  "command": "cd $PROJECT_ROOT"
                },
                {
                  "solution": "Verify Dockerfile exists",
                  "command": "ls -la Dockerfile"
                },
                {
                  "solution": "Check COPY paths in Dockerfile",
                  "verify": "All paths exist relative to Dockerfile location"
                }
              ]
            },
            "bad_interpreter_bash_m": {
              "error": "./build-and-push.sh: bad interpreter: /bin/bash^M",
              "diagnosis": "Windows line endings (CRLF) instead of Unix (LF)",
              "solutions": [
                {
                  "solution": "Fix line endings",
                  "command": "sed -i '' 's/\\r$//' build-and-push.sh"
                },
                {
                  "solution": "Make executable",
                  "command": "chmod +x build-and-push.sh"
                },
                {
                  "solution": "Run again",
                  "command": "./build-and-push.sh"
                }
              ]
            },
            "multi_platform_not_supported": {
              "error": "Multi-platform build is not supported for the docker driver",
              "diagnosis": "Default Docker driver doesn't support multi-platform",
              "solutions": [
                {
                  "solution": "Create buildx builder",
                  "command": "docker buildx create --name multiarch-builder --driver docker-container --use"
                },
                {
                  "solution": "Bootstrap builder",
                  "command": "docker buildx inspect --bootstrap"
                },
                {
                  "solution": "Run build script again",
                  "command": "./build-and-push.sh"
                }
              ]
            }
          }
        }
      ]
    },
    "docker_push_fails": {
      "symptom": "Pushing to Docker Hub fails",
      "decision_tree": [
        {
          "check": "What is the error?",
          "options": {
            "access_denied": {
              "error": "denied: requested access to the resource is denied",
              "diagnosis": "Not logged in to Docker Hub",
              "solutions": [
                {
                  "solution": "Login to Docker Hub",
                  "command": "docker login",
                  "credentials": {
                    "username": "binarybcc",
                    "password": "[Docker Hub password/token]"
                  }
                },
                {
                  "solution": "Verify logged in",
                  "command": "docker info | grep Username",
                  "expected": "Username: binarybcc"
                }
              ]
            },
            "repository_not_found": {
              "error": "repository does not exist",
              "diagnosis": "Repository name incorrect or doesn't exist",
              "solutions": [
                {
                  "solution": "Verify repository exists",
                  "url": "https://hub.docker.com/repository/docker/binarybcc/nwdownloads-circ/"
                },
                {
                  "solution": "Check image name in build script",
                  "correct_name": "binarybcc/nwdownloads-circ",
                  "file": "build-and-push.sh"
                }
              ]
            }
          }
        }
      ]
    },
    "production_deployment_fails": {
      "symptom": "Deployment to Synology NAS fails",
      "decision_tree": [
        {
          "check": "What operation fails?",
          "options": {
            "ssh_connection_fails": {
              "error": "Connection refused or timeout",
              "diagnosis": "Cannot connect to NAS",
              "solutions": [
                {
                  "solution": "Verify NAS is powered on and accessible",
                  "test": "ping 192.168.1.254"
                },
                {
                  "solution": "Check SSH is enabled on NAS",
                  "nas_settings": "Control Panel → Terminal & SNMP → Enable SSH service"
                },
                {
                  "solution": "Verify credentials",
                  "correct": "user: it, password: Mojave48ice"
                }
              ]
            },
            "docker_pull_fails": {
              "error": "pull access denied or image not found",
              "diagnosis": "Cannot pull from Docker Hub",
              "solutions": [
                {
                  "solution": "Login to Docker Hub on NAS",
                  "command": "sudo /usr/local/bin/docker login",
                  "credentials": "binarybcc / [password]"
                },
                {
                  "solution": "Verify image exists on Docker Hub",
                  "url": "https://hub.docker.com/repository/docker/binarybcc/nwdownloads-circ/tags",
                  "check": "latest tag exists and recently updated"
                },
                {
                  "solution": "Check internet connectivity from NAS",
                  "test": "ping hub.docker.com"
                }
              ]
            },
            "container_wont_start": {
              "error": "Container exits or shows unhealthy",
              "diagnosis": "Runtime error",
              "solutions": [
                {
                  "solution": "Check container logs",
                  "command": "sudo /usr/local/bin/docker logs circulation_web --tail 100"
                },
                {
                  "solution": "Common issues",
                  "checks": [
                    "Database not ready: Wait for health check",
                    "Port 8081 in use: netstat -an | grep 8081",
                    "Environment variables: Check docker-compose.prod.yml",
                    "File permissions: Check /volume1/docker/nwdownloads ownership"
                  ]
                }
              ]
            },
            "old_code_still_running": {
              "error": "Changes not visible after deployment",
              "diagnosis": "Container using old image",
              "solutions": [
                {
                  "solution": "Verify image digest",
                  "command": "sudo /usr/local/bin/docker inspect circulation_web | grep Image"
                },
                {
                  "solution": "Force recreate containers",
                  "command": "sudo /usr/local/bin/docker compose -f docker-compose.prod.yml up -d --force-recreate"
                },
                {
                  "solution": "Check Docker Hub image timestamp",
                  "verify": "Latest tag was actually pushed recently"
                }
              ]
            }
          }
        }
      ]
    },
    "data_looks_wrong": {
      "symptom": "Dashboard shows incorrect or unexpected data",
      "decision_tree": [
        {
          "check": "What looks wrong?",
          "options": {
            "no_data_for_week": {
              "symptom": "Dashboard shows 'No data for this week'",
              "diagnosis": "No snapshot for selected week",
              "solutions": [
                {
                  "solution": "Upload CSV for this week",
                  "url": "http://localhost:8081/upload.html"
                },
                {
                  "solution": "Select different week using date picker",
                  "action": "Click date picker, choose week with data"
                },
                {
                  "solution": "Check week calculation",
                  "note": "System uses Sunday-Saturday weeks (ISO 8601 with Sunday start)"
                }
              ]
            },
            "subscriber_counts_seem_wrong": {
              "diagnosis": "Data accuracy issue",
              "solutions": [
                {
                  "solution": "Verify upload summary matched expectations",
                  "check": "Review upload confirmation page totals"
                },
                {
                  "solution": "Check database directly",
                  "command": "docker exec circulation_db mariadb -ucirc_dash -p'Barnaby358@Jones!' -D circulation_dashboard -e \"SELECT * FROM daily_snapshots WHERE snapshot_date = (SELECT MAX(snapshot_date) FROM daily_snapshots);\""
                },
                {
                  "solution": "Compare to Newzware source data",
                  "action": "Open CSV in spreadsheet, verify totals match"
                },
                {
                  "solution": "Check for duplicate snapshots",
                  "query": "SELECT snapshot_date, paper_code, COUNT(*) FROM daily_snapshots GROUP BY snapshot_date, paper_code HAVING COUNT(*) > 1;"
                }
              ]
            },
            "year_over_year_shows_no_data": {
              "diagnosis": "Not enough historical data",
              "explanation": "Pre-2025 data was deleted due to rate system change",
              "current_data_range": "January 4, 2025 onwards",
              "solutions": [
                {
                  "solution": "Use week-over-week or month-over-month instead",
                  "note": "2026 will be first year with valid year-over-year"
                },
                {
                  "solution": "Accept limitation",
                  "rationale": "Old data was incomparable due to rate changes"
                }
              ]
            }
          }
        }
      ]
    },
    "performance_issues": {
      "symptom": "Dashboard loads slowly or times out",
      "decision_tree": [
        {
          "check": "What is slow?",
          "options": {
            "initial_page_load": {
              "normal_time": "2-3 seconds first visit, <500ms cached",
              "if_slower": {
                "solutions": [
                  {
                    "solution": "Check database query performance",
                    "command": "docker exec circulation_db mariadb -ucirc_dash -p'Barnaby358@Jones!' -D circulation_dashboard -e 'SHOW PROCESSLIST;'"
                  },
                  {
                    "solution": "Verify indexes exist",
                    "command": "docker exec circulation_db mariadb -ucirc_dash -p'Barnaby358@Jones!' -D circulation_dashboard -e 'SHOW INDEX FROM daily_snapshots;'",
                    "expected": "PRIMARY (snapshot_date, paper_code), date_idx, paper_idx"
                  },
                  {
                    "solution": "Check container resources",
                    "command": "docker stats circulation_web circulation_db"
                  }
                ]
              }
            },
            "csv_upload": {
              "normal_time": "10-30 seconds for ~8,000 rows",
              "if_slower": {
                "solutions": [
                  {
                    "solution": "Check file size",
                    "normal_size": "~1-2 MB"
                  },
                  {
                    "solution": "Monitor database during upload",
                    "command": "docker stats circulation_db"
                  },
                  {
                    "solution": "Check for locks",
                    "query": "SHOW OPEN TABLES WHERE In_use > 0;"
                  }
                ]
              }
            },
            "chart_rendering": {
              "normal_time": "~100ms per chart",
              "if_slower": {
                "solutions": [
                  {
                    "solution": "Check browser console for errors",
                    "action": "F12 → Console tab"
                  },
                  {
                    "solution": "Verify Chart.js loaded",
                    "test": "Type 'Chart' in browser console"
                  },
                  {
                    "solution": "Hard refresh browser",
                    "shortcut": "Ctrl+Shift+R or Cmd+Shift+R"
                  }
                ]
              }
            }
          }
        }
      ]
    }
  },
  "common_causes_index": {
    "database_connection_issues": [
      "Incorrect hostname (use 'database' not 'localhost')",
      "Database container not healthy",
      "Wrong credentials",
      "Network connectivity problem"
    ],
    "deployment_issues": [
      "Old image still running (force recreate)",
      "Image not pushed to Docker Hub",
      "Not logged in to Docker Hub",
      "Configuration file mismatch"
    ],
    "csv_upload_issues": [
      "Wrong CSV format (not All Subscriber Report)",
      "Missing required columns (Ed, ISS, DEL)",
      "Week-based precedence rejection (expected)",
      "Pre-2025 data (filtered out)"
    ],
    "rendering_issues": [
      "JavaScript errors (check console)",
      "No data in database",
      "API errors",
      "Browser cache"
    ],
    "performance_issues": [
      "Missing database indexes",
      "Large CSV files",
      "Container resource limits",
      "Network latency"
    ]
  },
  "quick_diagnostic_commands": {
    "check_everything": [
      "docker compose ps (container status)",
      "docker compose logs web --tail 50 (web errors)",
      "docker compose logs database --tail 50 (db errors)",
      "docker exec circulation_db mariadb -ucirc_dash -p'Barnaby358@Jones!' -e 'SELECT 1;' (db connectivity)",
      "curl http://localhost:8081 (web accessibility)",
      "curl http://localhost:8081/api.php?action=overview (API response)"
    ],
    "check_data": [
      "docker exec circulation_db mariadb -ucirc_dash -p'Barnaby358@Jones!' -D circulation_dashboard -e 'SELECT COUNT(*) FROM daily_snapshots;' (total records)",
      "docker exec circulation_db mariadb -ucirc_dash -p'Barnaby358@Jones!' -D circulation_dashboard -e 'SELECT MIN(snapshot_date), MAX(snapshot_date) FROM daily_snapshots;' (date range)",
      "docker exec circulation_db mariadb -ucirc_dash -p'Barnaby358@Jones!' -D circulation_dashboard -e 'SELECT * FROM daily_snapshots ORDER BY snapshot_date DESC LIMIT 5;' (latest data)"
    ]
  },
  "escalation_path": {
    "if_troubleshooting_fails": [
      "1. Document exact error message and steps to reproduce",
      "2. Gather logs (docker compose logs > debug.log)",
      "3. Check recent changes (git log)",
      "4. Consider rollback (see deployment-procedures.json → rollback_production)",
      "5. Review recent commits for breaking changes"
    ]
  }
}
